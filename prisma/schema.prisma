generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id            String        @id @default(uuid())
  name          String
  slug          String        @unique
  email         String
  phone         String?
  website       String?
  logo          String?
  widgetKey     String        @unique @map("widget_key")
  widgetTheme   Json?         @map("widget_theme")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  analytics     Analytics[]
  chats         Chat[]
  departments   Department[]
  roles         Role[]
  subscriptions Subscription?
  users         User[]

  @@index([slug])
  @@index([widgetKey])
  @@map("companies")
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  password        String
  firstName       String           @map("first_name")
  lastName        String           @map("last_name")
  avatar          String?
  phone           String?
  isActive        Boolean          @default(true) @map("is_active")
  isEmailVerified Boolean          @default(false) @map("is_email_verified")
  lastLoginAt     DateTime?        @map("last_login_at")
  companyId       String           @map("company_id")
  roleId          String           @map("role_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  analytics       Analytics[]
  chats           ChatAssignment[]
  messages        Message[]
  refreshTokens   RefreshToken[]
  userDepartments UserDepartment[]
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role            Role             @relation(fields: [roleId], references: [id])

  @@index([companyId])
  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Role {
  id              String           @id @default(uuid())
  name            String
  description     String?
  isSystem        Boolean          @default(false) @map("is_system")
  companyId       String?          @map("company_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users           User[]

  @@unique([name, companyId])
  @@index([companyId])
  @@map("roles")
}

model Permission {
  id              String           @id @default(uuid())
  name            String           @unique
  description     String?
  category        String
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Plan {
  id                       String         @id @default(uuid())
  name                     String         @unique
  slug                     String         @unique
  description              String?
  price                    Decimal        @db.Decimal(10, 2)
  currency                 String         @default("USD")
  billingCycle             String         @map("billing_cycle")
  maxUsers                 Int            @default(5) @map("max_users")
  maxAgents                Int            @default(3) @map("max_agents")
  maxDepartments           Int            @default(2) @map("max_departments")
  allowedFeatures          String[]       @map("allowed_features")
  chatHistoryRetentionDays Int            @default(90) @map("chat_history_retention_days")
  isActive                 Boolean        @default(true) @map("is_active")
  createdAt                DateTime       @default(now()) @map("created_at")
  updatedAt                DateTime       @updatedAt @map("updated_at")
  subscriptions            Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String    @id @default(uuid())
  companyId            String    @unique @map("company_id")
  planId               String    @map("plan_id")
  status               String
  currentPeriodStart   DateTime  @map("current_period_start")
  currentPeriodEnd     DateTime  @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  trialEndsAt          DateTime? @map("trial_ends_at")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  stripeCustomerId     String?   @map("stripe_customer_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  company              Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan                 Plan      @relation(fields: [planId], references: [id])

  @@index([companyId])
  @@index([status])
  @@map("subscriptions")
}

model Chat {
  id               String           @id @default(uuid())
  companyId        String           @map("company_id")
  visitorId        String?          @map("visitor_id")
  visitorName      String?          @map("visitor_name")
  visitorEmail     String?          @map("visitor_email")
  visitorPhone     String?          @map("visitor_phone")
  visitorIp        String?          @map("visitor_ip")
  visitorUserAgent String?          @map("visitor_user_agent")
  status           String           @default("pending")
  priority         String           @default("normal")
  departmentId     String?          @map("department_id")
  rating           Int?
  ratingComment    String?          @map("rating_comment")
  closedAt         DateTime?        @map("closed_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  assignments      ChatAssignment[]
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department       Department?      @relation(fields: [departmentId], references: [id])
  messages         Message[]

  @@index([companyId, status])
  @@index([companyId, createdAt(sort: Desc)])
  @@index([companyId, departmentId])
  @@index([visitorId])
  @@index([status])
  @@index([createdAt])
  @@map("chats")
}

model Message {
  id          String    @id @default(uuid())
  chatId      String    @map("chat_id")
  senderType  String    @map("sender_type")
  senderId    String?   @map("sender_id")
  content     String
  messageType String    @default("text") @map("message_type")
  metadata    Json?
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      User?     @relation(fields: [senderId], references: [id])

  @@index([chatId, createdAt])
  @@index([chatId, isRead])
  @@index([createdAt(sort: Desc)])
  @@index([senderId])
  @@index([senderType])
  @@map("messages")
}

model ChatAssignment {
  id           String    @id @default(uuid())
  chatId       String    @map("chat_id")
  agentId      String    @map("agent_id")
  assignedBy   String?   @map("assigned_by")
  assignedAt   DateTime  @default(now()) @map("assigned_at")
  unassignedAt DateTime? @map("unassigned_at")
  isActive     Boolean   @default(true) @map("is_active")
  agent        User      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  chat         Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([agentId])
  @@index([isActive])
  @@map("chat_assignments")
}

model Department {
  id              String           @id @default(uuid())
  companyId       String           @map("company_id")
  name            String
  description     String?
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  chats           Chat[]
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userDepartments UserDepartment[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("departments")
}

model UserDepartment {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  departmentId String     @map("department_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
  @@map("user_departments")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Analytics {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  userId    String?  @map("user_id")
  eventType String   @map("event_type")
  eventData Json?    @map("event_data")
  createdAt DateTime @default(now()) @map("created_at")
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([eventType])
  @@index([createdAt])
  @@map("analytics")
}
